{% extends "base.html" %}

{% block title %}Estadísticas - CineHub{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container">
    <div class="page-header">
        <h1><i class="fas fa-chart-pie"></i> Panel de Estadísticas</h1>
    </div>

    {# 5 KPIs - Estética mejorada con iconos temáticos #}
    <div class="stats-kpi-grid">
        <div class="kpi-card">
            <div class="kpi-icon"><i class="fas fa-users"></i></div>
            <div class="kpi-info">
                <h3>{{ n_usuarios }}</h3>
                <p>Usuarios Activos</p>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon" style="background: linear-gradient(135deg, #e50914 0%, #b20710 100%);"><i class="fas fa-film"></i></div>
            <div class="kpi-info">
                <h3>{{ n_titulos }}</h3>
                <p>Títulos en Catálogo</p>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon global-score"><i class="fas fa-trophy"></i></div>
            <div class="kpi-info">
                <h3>{{ promedio_global }} / 5</h3>
                <p>Puntuación Global</p>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon" style="background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%);"><i class="fas fa-star"></i></div>
            <div class="kpi-info">
                <h3>{{ n_valoraciones }}</h3>
                <p>Valoraciones Totales</p>
            </div>
        </div>
         <div class="kpi-card">
            <div class="kpi-icon rutinas"><i class="fas fa-calendar-check"></i></div>
            <div class="kpi-info">
                <h3>{{ n_rutinas }}</h3>
                <p>Maratones Agendadas</p>
            </div>
        </div>
    </div>

    {# Nueva Cuadrícula de 3 Gráficos #}
    <div class="charts-grid" style="grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));">

        <div class="chart-container">
            <h3><i class="fas fa-poll"></i> Top 5 Géneros con más Títulos</h3>
            <canvas id="genreChart"></canvas>
        </div>

        <div class="chart-container">
            <h3><i class="fas fa-trophy"></i> Top 5 Mejor Valoradas (Promedio)</h3>
            <canvas id="topRatedChart"></canvas>
        </div>

        <div class="chart-container">
            <h3><i class="fas fa-chart-line"></i> Top 5 Años con más Estrenos</h3>
            <canvas id="titlesByYearChart"></canvas>
        </div>

        <div class="chart-container" style="grid-column: span 3;">
            <h3><i class="fas fa-comments"></i> Top 5 Géneros más Comentados (Reseñas)</h3>
            <canvas id="mostRatedGenresChart" style="max-height: 400px;"></canvas>
        </div>

    </div>
</div>

<style>
    /* Estilos se movieron o ampliaron en style.css, pero se mantienen aquí para un contexto inmediato */
    .stats-kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Más compacto */
        gap: 20px;
        margin-bottom: 40px;
    }
    .kpi-card {
        background: #1c1c1c;
        padding: 20px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        gap: 20px;
        box-shadow: 0 0 15px rgba(229, 9, 20, 0.1);
        border: 1px solid rgba(229, 9, 20, 0.2);
    }
    .kpi-icon {
        width: 60px;
        height: 60px;
        /* ... (colores definidos en style.css) */
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
    }
    .kpi-icon.rutinas { background: linear-gradient(135deg, #00b4d8 0%, #0077b6 100%); }
    .kpi-icon.global-score { background: linear-gradient(135deg, #ffc107 0%, #e98074 100%); }

    .kpi-info h3 { font-size: 1.8rem; margin: 0; color: #f5f5f1; }
    .kpi-info p { margin: 0; color: #888; }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 30px;
    }
    .chart-container {
        background: #221f1f;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .chart-container h3 {
        color: #e50914;
        margin-bottom: 20px;
        border-bottom: 2px solid rgba(229, 9, 20, 0.5);
        padding-bottom: 10px;
    }
</style>

<script>
    // Colores base de la paleta CineHub
    const primaryColor = 'rgba(229, 9, 20, 0.8)';
    const secondaryColor = '#555';
    const warningColor = 'rgba(255, 193, 7, 0.9)';
    const infoColor = 'rgba(0, 180, 216, 0.8)';

    // Función de utilidades para configurar el texto blanco y grises en Chart.js
    const cinematicOptions = {
        responsive: true,
        plugins: {
            legend: {
                labels: { color: '#ccc' }
            }
        },
        scales: {
            x: {
                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                ticks: { color: '#ccc' }
            },
            y: {
                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                ticks: { color: '#ccc' }
            }
        }
    };

    // 1. Gráfica Top Rated (Barra Horizontal) - Puntuación Promedio
    const ctxTop = document.getElementById('topRatedChart').getContext('2d');
    new Chart(ctxTop, {
        type: 'bar',
        data: {
            labels: {{ top_rated_labels | tojson }},
            datasets: [{
                label: 'Puntuación Promedio',
                data: {{ top_rated_data | tojson }},
                backgroundColor: primaryColor,
            }]
        },
        options: {
            ...cinematicOptions,
            indexAxis: 'y',
            scales: {
                ...cinematicOptions.scales,
                x: { beginAtZero: true, max: 5 }
            },
            plugins: { legend: { display: false } }
        }
    });

    // 2. Gráfica Títulos por Género (Dona) - Conteo de Títulos
    const ctxGenre = document.getElementById('genreChart').getContext('2d');
    new Chart(ctxGenre, {
        type: 'doughnut',
        data: {
            labels: {{ genre_labels | tojson }},
            datasets: [{
                data: {{ genre_data | tojson }},
                backgroundColor: [primaryColor, secondaryColor, warningColor, infoColor, '#46d369', '#667eea', '#ff9ff3'],
                borderWidth: 0
            }]
        },
        options: {
            ...cinematicOptions,
            plugins: {
                legend: { position: 'right', labels: { color: '#ccc' } }
            }
        }
    });

    // 3. NUEVA GRÁFICA: Top 5 Géneros más Comentados (Barra Vertical)
    const ctxMostRated = document.getElementById('mostRatedGenresChart').getContext('2d');
    new Chart(ctxMostRated, {
        type: 'bar',
        data: {
            labels: {{ most_rated_genres_labels | tojson }},
            datasets: [{
                label: 'Total de Reseñas',
                data: {{ most_rated_genres_data | tojson }},
                backgroundColor: infoColor,
            }]
        },
        options: {
             ...cinematicOptions,
            plugins: { legend: { display: false } }
        }
    });

    // 4. NUEVA GRÁFICA: Títulos por Año de Estreno (Línea)
    const ctxTitlesByYear = document.getElementById('titlesByYearChart').getContext('2d');
    new Chart(ctxTitlesByYear, {
        type: 'line',
        data: {
            labels: {{ titles_by_year_labels | tojson }},
            datasets: [{
                label: 'Títulos Estrenados',
                data: {{ titles_by_year_data | tojson }},
                borderColor: warningColor,
                backgroundColor: 'rgba(255, 193, 7, 0.2)',
                tension: 0.4,
                pointBackgroundColor: warningColor,
            }]
        },
        options: {
            ...cinematicOptions,
            scales: {
                ...cinematicOptions.scales,
                y: { beginAtZero: true }
            }
        }
    });
</script>
{% endblock %}